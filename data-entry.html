<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作数据录入 - 声度星主持</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script>
        // Check if Vue is loaded
        window.addEventListener('load', () => {
            if (typeof Vue === 'undefined') {
                console.error('Vue failed to load from CDN. Please check your internet connection.');
            }
        });
    </script>
    <style>
        [v-cloak] { display: none; }
        .table-container { overflow-x: auto; }
        .data-table th { white-space: nowrap; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; padding: 12px 16px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; text-align: center; }
        .data-table td { padding: 8px 16px; border-bottom: 1px solid #f1f5f9; font-size: 13px; text-align: center; }
        .input-cell { width: 80px; text-align: center; border: 1px solid transparent; border-radius: 4px; padding: 4px 8px; transition: all 0.2s; background: transparent; font-weight: 600; color: #1e293b; }
        .input-cell:hover:not(:disabled) { border-color: #cbd5e1; background: #fff; }
        .input-cell:focus { border-color: #3b82f6; background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-cell:disabled { color: #94a3b8; cursor: not-allowed; font-weight: normal; }
        .summary-row { background-color: #f1f5f9; }
        .child-row { background-color: #fff; }
        .grand-total-row { background-color: #7f1d1d; color: white; }
        .grand-total-row td { border-bottom: none; font-weight: 900; }
        .grand-total-row .input-cell { color: white; }
        
        /* 隐藏数字输入框默认的上下调节按钮 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="app" v-cloak class="min-h-screen flex">
        <!-- Sidebar Navigation -->
        <aside class="w-52 bg-white border-r border-slate-200 flex flex-col fixed left-0 top-0 h-screen z-20">
            <div class="p-6 border-b border-slate-100 flex items-center gap-2.5">
                <div class="bg-amber-500 p-1.5 rounded-lg shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-slate-800">工作数据</h1>
            </div>
            
            <nav class="flex-grow p-4 space-y-1.5 overflow-y-auto">
                <a href="index.html" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-[13px] font-bold transition-all text-slate-600 hover:bg-slate-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    仪表盘
                </a>
                <div class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-[13px] font-bold transition-all bg-amber-50 text-amber-600 shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    工作数据
                </div>
                <a href="performance.html" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-[13px] font-bold transition-all text-slate-600 hover:bg-slate-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    绩效考核
                </a>
                <a href="salary-calculation.html" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-[13px] font-bold transition-all text-slate-600 hover:bg-slate-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    工资计算
                </a>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <button @click="exportToCSV" class="w-full bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-[12px] hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    导出报表
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col min-w-0 ml-52">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-8 py-4 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xl font-black text-slate-800 tracking-tight">月度工作数据</h2>
                    </div>
                    
                    <!-- Month Selector -->
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-50 rounded-lg border border-slate-200">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <input type="month" v-model="currentMonth" min="2025-01" max="2026-12" class="bg-transparent border-none text-sm font-bold text-slate-700 focus:ring-0 cursor-pointer">
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- History Button -->
                    <button @click="showHistory = true" class="flex items-center gap-2 px-4 py-1.5 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-all shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        历史记录
                    </button>

                    <!-- Save Status -->
                    <div class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-all"
                         :class="{
                             'bg-slate-100 text-slate-400': !saveStatus,
                             'bg-blue-50 text-blue-600': saveStatus === 'saving',
                             'bg-green-50 text-green-600': saveStatus === 'saved',
                             'bg-red-50 text-red-600': saveStatus === 'error'
                         }">
                        <div v-if="saveStatus === 'saving'" class="w-2 h-2 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <div v-else class="w-2 h-2 rounded-full" 
                             :class="{
                                 'bg-slate-300': !saveStatus,
                                 'bg-green-500': saveStatus === 'saved',
                                 'bg-red-500': saveStatus === 'error'
                             }"></div>
                        <span>{{ saveStatus === 'saving' ? '正在保存...' : (saveStatus === 'saved' ? '已自动保存' : (saveStatus === 'error' ? '保存失败' : '自动保存中')) }}</span>
                    </div>
                </div>
            </header>

            <!-- Table Section -->
            <div class="p-8">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="table-container">
                        <table class="data-table w-full text-left border-collapse">
                            <thead>
                                <tr>
                                    <th v-for="col in columns" :key="col.key" :style="{ width: col.width || (col.key === 'name' ? '140px' : 'auto') }">
                                        {{ col.label }}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Special Case: 小花老师 Summary & Children -->
                                <template v-for="id in ['小花老师', 'xh_la', 'xh_ch']" :key="id">
                                    <tr v-if="tableData[id] && (tableData[id].isSummary || expandedRows['小花老师'])" 
                                        :class="tableData[id].isSummary ? 'summary-row' : 'child-row'">
                                        <td v-for="col in columns" :key="col.key">
                                            
                                            <!-- Name Column -->
                                            <div v-if="col.key === 'name'" class="flex items-center gap-2 px-2">
                                                <div v-if="tableData[id].isSummary" 
                                                     @click="expandedRows['小花老师'] = !expandedRows['小花老师']"
                                                     class="flex items-center gap-2 cursor-pointer group">
                                                    <div class="w-1.5 h-1.5 rounded-full bg-blue-600"></div>
                                                    <span class="font-black text-slate-900 whitespace-nowrap">{{ tableData[id].name }}</span>
                                                    <svg :class="['w-3.5 h-3.5 text-slate-400 transition-transform duration-200', expandedRows['小花老师'] ? 'rotate-180' : '']" 
                                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div v-else class="flex items-center gap-2 ml-4">
                                                    <div class="w-4 h-px bg-slate-300"></div>
                                                    <span class="text-slate-600 font-bold whitespace-nowrap">{{ tableData[id].name }}</span>
                                                </div>
                                            </div>

                                            <!-- Number Input -->
                                            <template v-else-if="col.type === 'number'">
                                                <!-- Summary or Disabled: Display formatted text -->
                                                <span v-if="tableData[id].isSummary || (tableData[id].isTeachingDisabled && teachingColumns.includes(col.key))"
                                                      class="font-bold text-slate-700">
                                                    {{ tableData[id].isTeachingDisabled && teachingColumns.includes(col.key) ? '/' : (col.decimals !== undefined ? Number(tableData[id][col.key] || 0).toFixed(col.decimals) : tableData[id][col.key]) }}
                                                </span>
                                                <!-- Editable: Input field -->
                                                <input v-else
                                                       type="number"
                                                       v-model.number="tableData[id][col.key]"
                                                       @input="handleInputChange(id, col.key)"
                                                       :step="col.decimals === 2 ? '0.01' : (col.decimals === 1 ? '0.1' : '1')"
                                                       class="input-cell"
                                                       placeholder="0">
                                            </template>

                                            <!-- Formula Display -->
                                            <span v-else-if="col.type === 'formula'" class="font-bold"
                                                  :class="tableData[id].isTeachingDisabled && teachingColumns.includes(col.key) ? 'text-slate-300' : 'text-blue-600'">
                                                {{ tableData[id].isTeachingDisabled && teachingColumns.includes(col.key) ? '/' : col.formula(tableData[id]) }}
                                            </span>

                                            <!-- Special Case for 小草老师 / disabled columns -->
                                            <span v-else-if="tableData[id].isTeachingDisabled && teachingColumns.includes(col.key)" class="text-slate-300">/</span>
                                        </td>
                                    </tr>
                                </template>

                                <!-- Other Teachers -->
                                <template v-for="id in ['tz', 'yz', 'xc']" :key="id">
                                    <tr v-if="tableData[id]">
                                        <td v-for="col in columns" :key="col.key">
                                            
                                            <!-- Name Column -->
                                            <div v-if="col.key === 'name'" class="flex items-center gap-2 px-2">
                                                <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                                <span class="font-black text-slate-800 whitespace-nowrap">{{ tableData[id].name }}</span>
                                            </div>

                                            <!-- Number Input -->
                                            <template v-else-if="col.type === 'number'">
                                                <!-- Summary or Disabled: Display formatted text -->
                                                <span v-if="tableData[id].isTeachingDisabled && teachingColumns.includes(col.key)"
                                                      class="font-bold text-slate-700">
                                                    /
                                                </span>
                                                <!-- Editable: Input field -->
                                                <input v-else
                                                       type="number"
                                                       v-model.number="tableData[id][col.key]"
                                                       @input="handleInputChange(id, col.key)"
                                                       :step="col.decimals === 2 ? '0.01' : (col.decimals === 1 ? '0.1' : '1')"
                                                       class="input-cell"
                                                       placeholder="0">
                                            </template>

                                            <!-- Formula Display -->
                                            <span v-else-if="col.type === 'formula'" class="font-bold"
                                                  :class="tableData[id].isTeachingDisabled && teachingColumns.includes(col.key) ? 'text-slate-300' : 'text-blue-600'">
                                                {{ tableData[id].isTeachingDisabled && teachingColumns.includes(col.key) ? '/' : col.formula(tableData[id]) }}
                                            </span>
                                        </td>
                                    </tr>
                                </template>

                                <!-- Grand Total Row -->
                                <tr class="grand-total-row">
                                    <td v-for="col in columns" :key="col.key">
                                        <span v-if="col.key === 'name'" class="tracking-[0.2em]">汇总</span>
                                        <span v-else-if="col.type === 'number'">{{ col.decimals !== undefined ? Number(grandTotal[col.key] || 0).toFixed(col.decimals) : grandTotal[col.key] }}</span>
                                        <span v-else-if="col.type === 'formula'">{{ col.formula(grandTotal) }}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Legend / Notes -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-amber-50 border border-amber-100 rounded-xl p-5">
                        <h4 class="text-amber-800 font-bold text-sm mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            录入说明
                        </h4>
                        <p class="text-amber-700 text-xs leading-relaxed">
                            1. <strong>小花老师</strong>的数据由下方两个校区自动汇总，请直接修改校区数据。<br>
                            2. <strong>小草老师</strong>不涉及授课任务，相关单元格已标记为 "/"。<br>
                            3. 所有数据实时保存至本地，刷新页面不会丢失。
                        </p>
                    </div>
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-5">
                        <h4 class="text-blue-800 font-bold text-sm mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            计算逻辑
                        </h4>
                        <p class="text-blue-700 text-xs leading-relaxed">
                            - <strong>试听转化率</strong> = 报课人数 / 上课人数<br>
                            - <strong>总业绩</strong> = 新签业绩 + 续费业绩<br>
                            - <strong>出勤率</strong> = 出勤 / (出勤 + 缺勤 + 请假)
                        </p>
                    </div>
                    <div class="bg-slate-100 border border-slate-200 rounded-xl p-5">
                        <h4 class="text-slate-800 font-bold text-sm mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            数据导出
                        </h4>
                        <p class="text-slate-600 text-xs leading-relaxed">
                            点击左侧“导出报表”可将当前数据导出为 CSV 格式，支持使用 Excel 或 WPS 打开进一步编辑和存档。
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- History Modal -->
        <div v-cloak v-if="showHistory" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" style="display: none;" :style="{ display: showHistory ? 'flex' : 'none' }">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-black text-slate-800 tracking-tight">历史版本记录</h3>
                        <p class="text-xs text-slate-500 mt-1">查看或恢复 {{currentMonth}} 的历史工作数据</p>
                    </div>
                    <button @click="showHistory = false" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="p-6 bg-slate-50 border-b border-slate-100">
                    <div class="flex items-center gap-3">
                        <input type="text" v-model="historyNote" placeholder="输入版本备注（如：1月第1次更新）" 
                               class="flex-grow bg-white border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-amber-500 outline-none transition-all">
                        <button @click="saveHistoryRecord(false)" class="bg-amber-600 text-white px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-amber-700 transition-all shadow-sm">
                            保存新版本
                        </button>
                    </div>
                    <div v-if="currentVersionId" class="mt-4 p-3 bg-blue-50 border border-blue-100 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-blue-600 animate-pulse"></div>
                            <span class="text-xs font-bold text-blue-700">正在编辑版本：{{ historyRecords.find(r => r.id === currentVersionId)?.note }}</span>
                        </div>
                        <button @click="saveHistoryRecord(true)" class="text-xs font-black text-blue-600 hover:text-blue-800 transition-colors">
                            替换此版本内容
                        </button>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                    <div v-if="historyRecords.length === 0" class="text-center py-12">
                        <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <p class="text-slate-500 font-medium">暂无历史记录</p>
                    </div>
                    
                    <div v-for="record in historyRecords" :key="record.id" 
                         class="group bg-white border rounded-xl p-4 transition-all hover:border-amber-200 hover:shadow-md"
                         :class="currentVersionId === record.id ? 'border-blue-200 bg-blue-50/30' : 'border-slate-100'">
                        <div class="flex items-start justify-between">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-800">{{ record.note }}</span>
                                    <span v-if="currentVersionId === record.id" class="px-2 py-0.5 bg-blue-600 text-[10px] text-white rounded-full">当前加载</span>
                                </div>
                                <div class="flex items-center gap-3 mt-1.5">
                                    <div class="flex items-center gap-1 text-[11px] text-slate-400">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        {{ record.displayTime }}
                                    </div>
                                    <div class="flex items-center gap-1 text-[11px] text-slate-400">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                        管理员
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="loadVersion(record)" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg transition-colors title='加载版本'">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </button>
                                <button @click="deleteVersion(record.id)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="删除">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end">
                    <button @click="showHistory = false" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-800 transition-all">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="data-entry.js"></script>
</body>
</html>
