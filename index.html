<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声度星主持 - 数据复盘仪表盘</title>
    <script src="lib/tailwind.js"></script>
    <script src="lib/vue.global.js"></script>
    <script src="lib/echarts.min.js"></script>
    <script src="lib/dayjs.min.js"></script>
    <script src="auth-guard.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [v-cloak] { display: none; }
        .chart-container { min-height: 300px; width: 100%; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Modern Tab Switcher Styles */
        .segmented-control {
            position: relative;
            display: flex;
            background-color: #f1f5f9; /* slate-100 */
            padding: 2px;
            border-radius: 12px;
            isolation: isolate;
        }
        .segmented-control .indicator {
            position: absolute;
            top: 2px;
            bottom: 2px;
            left: 2px;
            width: calc(33.333% - 2px);
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }
        .segmented-control button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b; /* slate-500 */
            transition: color 0.3s;
            white-space: nowrap;
        }
        .segmented-control button.active {
            color: #2563eb; /* blue-600 */
        }
        .tab-exp .indicator { transform: translateX(0); }
        .tab-enr .indicator { transform: translateX(100%); }
        .tab-con .indicator { transform: translateX(200%); }

        /* Mobile Adaptations */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch !important;
                gap: 0.75rem !important;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .filter-container {
                width: 100%;
                justify-content: space-between;
            }
            .segmented-control {
                width: 100%;
                margin-right: 0 !important;
            }
            .main-content {
                padding: 1rem !important;
            }
            .kpi-grid {
                grid-template-cols: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            .kpi-card {
                padding: 1rem !important;
            }
            .kpi-card h3 {
                font-size: 1.5rem !important;
            }
            .chart-row {
                grid-template-columns: 1fr !important;
            }
        }

        /* Date Picker Popover */
        .datepicker-popover {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 280px;
            z-index: 100;
            padding: 1.25rem;
            animation: popover-in 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 768px) {
            .datepicker-popover {
                left: auto;
                right: 0;
                transform: none;
            }
        }

        @keyframes popover-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .month-btn {
            padding: 0.6rem 0.4rem;
            text-align: center;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
            color: #64748b;
        }

        .month-btn:hover {
            background: #f1f5f9;
            color: #2563eb;
        }

        .month-btn.active {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .year-tab-container {
            display: flex;
            background: #f1f5f9;
            padding: 3px;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .year-tab {
            flex: 1;
            padding: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
        }

        .year-tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- Top Navigation / Filter Bar -->
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm px-4 py-2 md:px-8">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4 header-content">
                <div class="flex items-center justify-between gap-4 md:gap-8 w-full md:w-auto">
                    <!-- Title & Logo -->
                    <div class="flex items-center gap-2 shrink-0">
                        <div class="bg-blue-600 p-1.5 rounded-lg">
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-white"></i>
                        </div>
                        <h1 class="text-base font-bold tracking-tight whitespace-nowrap">声度星主持仪表盘</h1>
                    </div>

                    <!-- Unified Date Picker -->
                    <div class="relative">
                        <button @click="showDatePicker = !showDatePicker" 
                                class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 px-3 py-1.5 md:px-4 md:py-2 rounded-xl border border-slate-200 transition-all duration-200 group">
                            <i data-lucide="calendar" class="w-4 h-4 text-slate-500 group-hover:text-blue-600"></i>
                            <span class="text-xs font-bold text-slate-700">
                                {{ globalFilter.type === 'year' ? globalFilter.year + '年度' : globalFilter.month.split('-')[0] + '年' + globalFilter.month.split('-')[1] + '月' }}
                            </span>
                            <i data-lucide="chevron-down" :class="['w-3 h-3 text-slate-400 transition-transform duration-200', showDatePicker ? 'rotate-180' : '']"></i>
                        </button>

                        <!-- Date Picker Popover -->
                        <div v-if="showDatePicker" v-cloak class="datepicker-popover">
                            <div class="year-tab-container">
                                <div v-for="y in ['2025', '2026']" :key="y" 
                                     @click="pickerTempYear = y"
                                     :class="['year-tab', pickerTempYear === y ? 'active' : '']">
                                    {{y}}年
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-2">
                                <button @click="selectYear(pickerTempYear)"
                                        :class="['w-full py-2 rounded-lg text-xs font-bold transition-all border', 
                                                 globalFilter.type === 'year' && globalFilter.year === pickerTempYear ? 'bg-blue-600 text-white border-blue-600' : 'bg-slate-50 text-slate-600 border-slate-100 hover:bg-slate-100']">
                                    查看整年数据
                                </button>
                            </div>

                            <div class="month-grid">
                                <button v-for="m in 12" :key="m"
                                        @click="selectMonth(pickerTempYear, m)"
                                        :class="['month-btn', globalFilter.type === 'month' && globalFilter.month === pickerTempYear + '-' + String(m).padStart(2, '0') ? 'active' : '']">
                                    {{m}}月
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-2 w-full md:w-auto">
                    <!-- Tab Switcher (Show on mobile too, but styled for full width) -->
                    <div :class="['flex segmented-control', 
                                  currentTab === 'experience' ? 'tab-exp' : 
                                  currentTab === 'enrollment' ? 'tab-enr' : 'tab-con']">
                        <div class="indicator"></div>
                        <button @click="currentTab = 'experience'" :class="{ active: currentTab === 'experience' }">体验</button>
                        <button @click="currentTab = 'enrollment'" :class="{ active: currentTab === 'enrollment' }">业绩</button>
                        <button @click="currentTab = 'consumption'" :class="{ active: currentTab === 'consumption' }">课消</button>
                    </div>
                    
                    <div class="flex items-center gap-1.5">
                        <a href="home-dashboard.html" title="数据大屏" class="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-xl transition-all duration-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </a>
                        <a href="data-entry.html" title="工作数据" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all duration-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </a>
                        <a href="performance.html" title="绩效考核" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all duration-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </a>
                        <button @click="showImport = true" title="导入数据" class="ml-1 bg-blue-600 hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-200 text-white p-2 rounded-xl transition-all duration-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8 main-content">
            <!-- Global Filter Bar Removed from here -->

            <!-- Dashboard Content -->
            <div v-if="currentTab === 'experience'" class="space-y-8 animate-in fade-in duration-500">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 kpi-grid">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative group kpi-card">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-sm text-slate-500">邀约人数</p>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900">{{kpis.exp_invited}}</h3>
                        <div class="mt-2 text-xs text-slate-400">本期邀约学员总数</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 kpi-card">
                        <p class="text-sm text-slate-500 mb-1">体验人数</p>
                        <h3 class="text-3xl font-bold text-slate-900">{{kpis.exp_attended}}</h3>
                        <div class="mt-2 text-xs text-blue-600 flex items-center justify-between">
                            <span>到访率: {{kpis.exp_attend_rate}}%</span>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 kpi-card">
                        <p class="text-sm text-slate-500 mb-1">已报课人数</p>
                        <h3 class="text-3xl font-bold text-emerald-600">{{kpis.exp_enrolled}}</h3>
                        <div class="mt-2 text-xs text-emerald-600">从体验数据转化的报课学员</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 kpi-card">
                        <p class="text-sm text-slate-500 mb-1">报课转化率</p>
                        <h3 class="text-3xl font-bold text-blue-600">{{kpis.exp_conv_rate}}%</h3>
                        <div class="mt-2 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600" :style="{width: kpis.exp_conv_rate + '%'}"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 chart-row">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">年级分布</h4>
                            <div class="flex gap-2">
                                <select v-model="chartFilters.grade.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                    <option value="all">全部校区</option>
                                    <option v-for="c in campusList" :value="c">{{c}}</option>
                                </select>
                            </div>
                        </div>
                        <div id="gradeChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">学员来源渠道</h4>
                        </div>
                        <div id="sourceChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-1">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">性别比例</h4>
                            <select v-model="chartFilters.gender.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                <option value="all">全部</option>
                                <option v-for="c in campusList" :value="c">{{c}}</option>
                            </select>
                        </div>
                        <div id="genderChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">体验转化漏斗</h4>
                            <div class="flex gap-2">
                                <select v-model="chartFilters.funnel.teacher" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                    <option value="all">全部老师</option>
                                    <option v-for="t in teacherList" :value="t">{{t}}</option>
                                </select>
                            </div>
                        </div>
                        <div id="funnelChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Teacher Stats -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold">体验老师转化统计</h4>
                    </div>
                    <div id="teacherExpChart" class="chart-container" style="height: 400px;"></div>
                </div>

                <!-- 体验明细数据表格 -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100/50 transition-colors" @click="expTableExpanded = !expTableExpanded">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            {{ globalFilter.type === 'year' ? globalFilter.year + '年度' : globalFilter.month + '月度' }}体验明细
                        </h3>
                        <div class="flex items-center gap-4">
                            <div class="flex gap-2" @click.stop>
                                <input v-model="expSearch" type="text" placeholder="搜索学员/老师/状态..." class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none w-48">
                            </div>
                            <svg :class="['w-5 h-5 text-slate-400 transition-transform duration-300', expTableExpanded ? 'rotate-180' : '']" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div v-show="expTableExpanded" class="overflow-x-auto max-h-[600px] overflow-y-auto animate-in slide-in-from-top-2 duration-300">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 font-semibold text-slate-600">学员姓名</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">年级/性别</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">学员来源</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">体验日期</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">邀约老师</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">体验老师</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">校区</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">状态</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="(item, idx) in searchedExperienceDetails" :key="idx" class="hover:bg-slate-50/80 transition-colors">
                                    <td class="px-4 py-3 font-medium text-slate-700">{{item.学员姓名}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.年级 || item.年龄}} / {{item.性别 || '未知'}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.学员来源 || '未知'}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.体验课时间}}</td>
                                    <td class="px-4 py-3 text-slate-700">{{item.邀约老师}}</td>
                                    <td class="px-4 py-3 text-slate-700">{{item.体验课老师}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.所在校区}}</td>
                                    <td class="px-4 py-3">
                                        <span :class="['px-2 py-0.5 rounded-full text-[10px]', 
                                            item.状态 === '已报课' ? 'bg-emerald-50 text-emerald-600' : 
                                            (item.状态 === '已体验' ? 'bg-blue-50 text-blue-600' : 'bg-slate-50 text-slate-500')]">
                                            {{item.状态}}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'enrollment'" class="space-y-8 animate-in fade-in duration-500">
                <!-- KPI Cards Enrollment -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-sm text-slate-500 mb-1">实收金额</p>
                        <h3 class="text-2xl font-bold text-slate-900">¥{{kpis.enr_revenue.toLocaleString()}}</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-sm text-slate-500 mb-1">报课总额</p>
                        <h3 class="text-2xl font-bold text-slate-900">¥{{kpis.enr_total_amount.toLocaleString()}}</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-sm text-slate-500 mb-1">新签合同</p>
                        <h3 class="text-2xl font-bold text-green-600">{{kpis.enr_new_contracts}}</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-sm text-slate-500 mb-1">续费合同</p>
                        <h3 class="text-2xl font-bold text-blue-600">{{kpis.enr_renew_contracts}}</h3>
                    </div>
                </div>

                <!-- Charts Row 1: Trend & Type -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">实收金额趋势 (近12个月)</h4>
                            <select v-model="chartFilters.revenueTrend.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                <option value="all">全部校区</option>
                                <option v-for="c in campusList" :value="c">{{c}}</option>
                            </select>
                        </div>
                        <div id="revenueTrendChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-1">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">报课属性占比</h4>
                        </div>
                        <div id="enrTypeChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- New Row: Performance Ranking & AOV -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">业绩排行</h4>
                            <div class="flex items-center gap-2">
                                <select v-model="chartFilters.ranking.type" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                    <option value="campus">按校区</option>
                                    <option value="teacher">按老师</option>
                                </select>
                            </div>
                        </div>
                        <div id="perfRankingChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">客单价 (AOV) 分析</h4>
                            <select v-model="chartFilters.aov.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                <option value="all">全部校区</option>
                                <option v-for="c in campusList" :value="c">{{c}}</option>
                            </select>
                        </div>
                        <div id="aovTrendChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Campus Performance -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold">校区业绩分布</h4>
                    </div>
                    <div id="campusPerfChart" class="chart-container"></div>
                </div>

                <!-- 业绩明细数据表格 -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100/50 transition-colors" @click="enrTableExpanded = !enrTableExpanded">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            {{ globalFilter.type === 'year' ? globalFilter.year + '年度' : globalFilter.month + '月度' }}业绩明细
                        </h3>
                        <div class="flex items-center gap-4">
                            <div class="flex gap-2" @click.stop>
                                <input v-model="enrSearch" type="text" placeholder="搜索学员/老师..." class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none w-48">
                            </div>
                            <svg :class="['w-5 h-5 text-slate-400 transition-transform duration-300', enrTableExpanded ? 'rotate-180' : '']" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div v-show="enrTableExpanded" class="overflow-x-auto max-h-[600px] overflow-y-auto animate-in slide-in-from-top-2 duration-300">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 font-semibold text-slate-600">学员姓名</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">时间</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">属性</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">课时</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">实收</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">校区</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">归属人</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">归属金额</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="(item, idx) in searchedEnrollmentDetails" :key="idx" class="hover:bg-slate-50/80 transition-colors">
                                    <td class="px-4 py-3 font-medium text-slate-700">{{item.学员姓名}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.报课时间}}</td>
                                    <td class="px-4 py-3">
                                        <span :class="['px-2 py-0.5 rounded-full text-[10px]', 
                                            item.报课属性 === '续费' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600']">
                                            {{item.报课属性}}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-slate-600">{{item.报课课时}}</td>
                                    <td class="px-4 py-3 font-semibold text-slate-900">¥{{item.实收金额.toLocaleString()}}</td>
                                    <td class="px-4 py-3 text-slate-500">{{item.所在校区}}</td>
                                    <td class="px-4 py-3 text-slate-700">{{item.业绩归属人}}</td>
                                    <td class="px-4 py-3 font-semibold text-blue-600">¥{{item.归属业绩金额.toLocaleString()}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'consumption'" class="space-y-8 animate-in fade-in duration-500">
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">总消课课时</p>
                        <h3 class="text-xl font-bold text-slate-900">{{conKpis.total_hours.toFixed(1)}}</h3>
                        <div class="mt-2 text-[10px] text-slate-400">学员消课总课时</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">消课总金额</p>
                        <h3 class="text-xl font-bold text-blue-600">¥{{conKpis.total_amount.toLocaleString()}}</h3>
                        <div class="mt-2 text-[10px] text-slate-400">消课课时总金额</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">一对一人次</p>
                        <h3 class="text-xl font-bold text-blue-600">{{conKpis.one_on_one_count}}</h3>
                        <div class="mt-2 text-[10px] text-slate-400">快速扣课计入次数</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">平均出勤率</p>
                        <h3 class="text-xl font-bold text-emerald-600">{{conKpis.attendance_rate}}%</h3>
                        <div class="mt-2 h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-500" :style="{width: conKpis.attendance_rate + '%'}"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">请假率</p>
                        <h3 class="text-xl font-bold text-amber-500">{{conKpis.leave_rate}}%</h3>
                        <div class="mt-2 h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-amber-400" :style="{width: conKpis.leave_rate + '%'}"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-500 mb-1">缺勤率</p>
                        <h3 class="text-xl font-bold text-rose-500">{{conKpis.absence_rate}}%</h3>
                        <div class="mt-2 h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-rose-400" :style="{width: conKpis.absence_rate + '%'}"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-1">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">老师课消排行</h4>
                            <select v-model="chartFilters.consumption.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                <option value="all">全部校区</option>
                                <option v-for="c in campusList" :value="c">{{c}}</option>
                            </select>
                        </div>
                        <div id="teacherRankChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-2">
                        <h4 class="font-bold mb-4">消课与出勤趋势</h4>
                        <div id="trendChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">出勤状态分布</h4>
                            <div class="text-[10px] text-slate-400">各类型人次占比</div>
                        </div>
                        <div id="compositionChart" class="chart-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">老师出勤细节对比</h4>
                            <select v-model="chartFilters.consumption.campus" class="text-[10px] bg-slate-50 border-none rounded py-1 px-2 focus:ring-0">
                                <option value="all">全部校区</option>
                                <option v-for="c in campusList" :value="c">{{c}}</option>
                            </select>
                        </div>
                        <div id="attendanceChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Detail Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100/50 transition-colors" @click="conTableExpanded = !conTableExpanded">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            {{ globalFilter.type === 'year' ? globalFilter.year + '年度' : globalFilter.month + '月度' }}课消明细
                        </h3>
                        <div class="flex items-center gap-4">
                            <div class="flex gap-2" @click.stop>
                                <select v-model="chartFilters.consumption.campus" class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">全部校区</option>
                                    <option v-for="c in campusList" :value="c">{{c}}</option>
                                </select>
                                <input v-model="conSearch" type="text" placeholder="搜索老师..." class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none w-48">
                            </div>
                            <svg :class="['w-5 h-5 text-slate-400 transition-transform duration-300', conTableExpanded ? 'rotate-180' : '']" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div v-show="conTableExpanded" class="overflow-x-auto max-h-[500px] animate-in slide-in-from-top-2 duration-300">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th v-if="globalFilter.type === 'year'" class="px-4 py-3 font-semibold text-slate-600">月份</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">老师姓名</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">校区</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">消课课时</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">一对一人次</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">消课金额</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">出勤</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">请假</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">缺勤</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">补课</th>
                                    <th class="px-4 py-3 font-semibold text-slate-600">出勤率</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template v-for="(group, gIdx) in groupedConsumptionDetails" :key="group.month">
                                    <tr v-if="globalFilter.type === 'year'" class="bg-slate-50/80 border-y border-slate-200/60">
                                        <td colspan="11" class="px-4 py-2 font-bold text-blue-600 text-[11px] flex items-center gap-2">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            {{ group.month.split('-')[0] }}年{{ group.month.split('-')[1] }}月
                                            <span class="text-[10px] font-normal text-slate-400 ml-2">(共 {{group.items.length}} 条记录)</span>
                                        </td>
                                    </tr>
                                    <tr v-for="(item, idx) in group.items" :key="idx" class="hover:bg-slate-50 transition-colors">
                                        <td v-if="globalFilter.type === 'year'" class="px-4 py-3 text-slate-400 font-medium">{{item.月份.split('-')[1]}}月</td>
                                        <td class="px-4 py-3 font-medium text-slate-700">{{item.姓名}}</td>
                                        <td class="px-4 py-3 text-slate-500">{{item.校区}}</td>
                                        <td class="px-4 py-3 text-slate-500 font-semibold">{{item.消课课时}}</td>
                                        <td class="px-4 py-3 text-slate-500">{{item.一对一人次}}</td>
                                        <td class="px-4 py-3 text-slate-500 font-medium">¥{{(item.消课金额 || 0).toLocaleString()}}</td>
                                        <td class="px-4 py-3 text-emerald-600 font-bold">{{item.出勤人次}}</td>
                                        <td class="px-4 py-3 text-amber-600 font-medium">{{item.请假人次}}</td>
                                        <td class="px-4 py-3 text-rose-600 font-medium">{{item.缺勤人次}}</td>
                                        <td class="px-4 py-3 text-blue-600 font-medium">{{item.补课人次}}</td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <span :class="[
                                                    'px-2 py-0.5 rounded text-[10px] font-bold',
                                                    ((item.出勤人次 / (item.出勤人次 + item.请假人次 + item.缺勤人次 || 1)) * 100) < 85 ? 'bg-rose-50 text-rose-600' : 
                                                    ((item.出勤人次 / (item.出勤人次 + item.请假人次 + item.缺勤人次 || 1)) * 100) > 95 ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-50 text-slate-600'
                                                ]">
                                                    {{ ((item.出勤人次 / (item.出勤人次 + item.请假人次 + item.缺勤人次 || 1)) * 100).toFixed(1) }}%
                                                </span>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Import Modal -->
        <div v-if="showImport" v-cloak style="display: none;" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="text-lg font-bold">导入业务数据</h3>
                    <button @click="showImport = false" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <label class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-xl p-8 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all">
                            <svg class="w-10 h-10 text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            <span class="text-sm font-medium">上传 Excel/CSV</span>
                            <span class="text-xs text-slate-400 mt-1">支持 .xlsx, .csv 格式</span>
                            <input type="file" class="hidden" accept=".xlsx,.csv" @change="handleExcelUpload">
                        </label>
                        <label class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-xl p-8 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all">
                            <svg class="w-10 h-10 text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>
                            <span class="text-sm font-medium">截图 OCR 识别</span>
                            <span class="text-xs text-slate-400 mt-1">上传截图自动解析数据</span>
                            <input type="file" class="hidden" accept="image/*" @change="handleImageUpload">
                        </label>
                    </div>
                    
                    <div v-if="importing" class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-sm text-slate-600">正在处理数据... {{importProgress}}%</span>
                    </div>

                    <div v-if="parsedData.length > 0" class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-bold text-blue-600">数据预校验 & 手动修正</h4>
                            <div class="flex gap-2">
                                <button @click="addEmptyRow" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded text-slate-600">+ 新增行</button>
                                <button @click="clearParsedData" class="text-xs text-red-500 hover:text-red-700">全部清除</button>
                            </div>
                        </div>
                        <div class="max-h-64 overflow-auto border border-slate-200 rounded-lg text-xs bg-slate-50">
                            <table class="w-full border-collapse">
                                <thead class="bg-slate-100 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-2 py-2 text-left border-b border-slate-200 w-8">#</th>
                                        <th v-for="key in Object.keys(parsedData[0])" :key="key" class="px-2 py-2 text-left border-b border-slate-200 min-w-[80px]">{{key}}</th>
                                        <th class="px-2 py-2 text-center border-b border-slate-200 w-10">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, idx) in parsedData" :key="idx" class="border-b border-slate-200 bg-white hover:bg-blue-50/50">
                                        <td class="px-2 py-2 text-slate-400 text-[10px]">{{idx + 1}}</td>
                                        <td v-for="(val, key) in row" :key="key" class="px-1 py-1">
                                            <input v-model="parsedData[idx][key]" class="w-full bg-transparent border-none focus:ring-1 focus:ring-blue-400 rounded px-1 py-1 text-xs" placeholder="-">
                                        </td>
                                        <td class="px-2 py-2 text-center">
                                            <button @click="removeRow(idx)" class="text-slate-300 hover:text-red-500 transition-colors">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 p-2 bg-blue-50 rounded-lg flex items-start gap-2">
                            <svg class="w-4 h-4 text-blue-500 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="text-[10px] text-blue-600 leading-relaxed">
                                <strong>提示：</strong> OCR 识别受限于图片清晰度，可能出现同音字或金额错误。请在点击“确认导入”前核对并修正。支持直接在表格内修改，修改后的数据将实时同步至仪表盘。
                            </p>
                        </div>
                        <div class="mt-4 flex flex-col gap-3">
                            <div v-if="saveStatus" :class="['text-center py-2 rounded-lg text-sm font-medium transition-all', saveStatus === 'saved' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600']">
                                {{ saveStatus === 'saved' ? '✓ 数据已导入' : '✕ 处理失败，请重试' }}
                            </div>
                            <button @click="confirmImport" class="w-full bg-blue-600 text-white py-2.5 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2">
                                <span>确认导入并更新看板</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-white border-t border-slate-200 py-6 px-4 text-center text-slate-400 text-xs">
            &copy; 2026 声度星主持 少儿口才培训机构 | 内部数据复盘专用
        </footer>
    </div>

    <!-- Application Script -->
    <script src="data-2025.js"></script>
    <script src="data-experience-2025.js"></script>
    <script src="data-consumption-2025.js"></script>
    <script src="data-2026.js"></script>
    <script src="data-experience-2026.js"></script>
    <script src="data-consumption-2026.js"></script>
    <script src="app.js"></script>
</body>
</html>
