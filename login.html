<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 声度星主持</title>
    <script src="lib/tailwind.js"></script>
    <style>
        :root {
            --bg-color: #050a0f;
            --card-bg: rgba(16, 24, 39, 0.95);
            --primary-blue: #00d2ff;
            --text-main: #e2e8f0;
            --border-color: rgba(0, 210, 255, 0.3);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-image: radial-gradient(circle at 50% 0%, rgba(0, 210, 255, 0.15) 0%, transparent 50%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.15);
            position: relative;
            z-index: 10;
        }
        input {
            position: relative;
            z-index: 20;
            cursor: text;
        }
        input:focus {
            background-color: rgba(30, 58, 138, 0.4) !important;
            border-color: var(--primary-blue) !important;
            box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="glass-card p-8 rounded-2xl w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold bg-gradient-to-b from-white to-blue-400 bg-clip-text text-transparent">声度星主持管理系统</h1>
            <p class="text-slate-400 text-sm mt-2">请登录以访问系统</p>
        </div>

        <form id="loginForm" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-blue-300 mb-2">用户名</label>
                <input type="text" id="username" name="username" required
                    class="w-full bg-blue-900/30 border border-blue-500/40 rounded-lg px-4 py-3 text-white focus:outline-none transition-all"
                    placeholder="请输入用户名" autocomplete="username">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-blue-300 mb-2">密码</label>
                <input type="password" id="password" name="password" required
                    class="w-full bg-blue-900/30 border border-blue-500/40 rounded-lg px-4 py-3 text-white focus:outline-none transition-all"
                    placeholder="请输入密码" autocomplete="current-password">
            </div>
            <div id="errorMessage" class="hidden text-red-400 text-sm bg-red-400/10 p-3 rounded-lg border border-red-400/20"></div>
            <button type="submit" id="loginBtn"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white font-bold py-3 rounded-lg hover:shadow-[0_0_15px_rgba(0,210,255,0.4)] transition-all active:scale-95">
                立即登录
            </button>
        </form>

        <div class="mt-8 text-center">
            <a href="home-dashboard.html" class="text-xs text-slate-500 hover:text-blue-400">← 返回公开仪表盘</a>
        </div>
    </div>

    <!-- 引入核心鉴权脚本 -->
    <script src="auth-guard.js"></script>

    <script>
        const API_HOST = window.location.hostname;
        const API_BASE = `${window.location.protocol}//${API_HOST}:5001`;

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.innerText = '正在验证...';
            errorDiv.classList.add('hidden');

            const LOCAL_USERS = {
                "sendo": { name: "总管理员", role: "admin" },
                "xiaohua": { name: "小花老师", role: "teacher" },
                "taozi": { name: "桃子老师", role: "teacher" },
                "youzi": { name: "柚子老师", role: "teacher" },
                "xiaocao": { name: "小草老师", role: "teacher" }
            };

            // 检查当前用户是否需要尝试后端登录
            let backendLoginSuccess = false;
            try {
                console.log('正在尝试后端登录:', username, 'API_BASE:', API_BASE);
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                console.log('后端登录响应:', data);

                if (response.ok && data.status === 'success') {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    backendLoginSuccess = true;
                    const params = new URLSearchParams(window.location.search);
                    let redirect = params.get('redirect') || 'home-dashboard.html';
                    
                    // 确保不重定向回登录页
                    if (redirect.toLowerCase().includes('login.html')) {
                        redirect = 'home-dashboard.html';
                    }
                    
                    console.log('后端登录成功，准备跳转:', redirect);
                    window.location.replace(redirect);
                    return;
                } else {
                    // 后端返回错误（如密码不对）
                    if (!LOCAL_USERS[username] || password !== '666888') {
                        errorDiv.innerText = data.message || '登录失败，请检查账号密码';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                }
            } catch (err) {
                console.error('后端登录请求异常:', err);
                // 后端可能没启动，继续尝试本地验证
            }

            // --- 本地验证逻辑开始 (作为后端不可用或特定密码的兜底) ---
            if (LOCAL_USERS[username] && password === '666888') {
                const user = {
                    username: username,
                    name: LOCAL_USERS[username].name,
                    role: LOCAL_USERS[username].role
                };
                localStorage.setItem('user', JSON.stringify(user));
                const params = new URLSearchParams(window.location.search);
                let redirect = params.get('redirect') || 'home-dashboard.html';
                
                // 确保不重定向回登录页
                if (redirect.toLowerCase().includes('login.html')) {
                    redirect = 'home-dashboard.html';
                }
                
                console.log('本地验证成功 (后端可能未建立会话)，跳转至:', redirect);
                window.location.replace(redirect);
                return;
            }
            // --- 本地验证逻辑结束 ---

            if (!backendLoginSuccess) {
                errorDiv.innerText = '登录请求失败 (请确保后端服务已启动)';
                errorDiv.classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
